<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Engineer Dashboard â€“ Easy 2 Work</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/style.css" rel="stylesheet">
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
    <div class="container">
      <a class="navbar-brand" href="/">Easy 2 Work</a>
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><span class="nav-link d-none d-md-inline" id="engName"></span></li>
        <li class="nav-item"><a class="nav-link" href="#" id="engLogout">Logout</a></li>
      </ul>
    </div>
  </nav>

  <div class="container dashboard-wrap">
    <div class="dash-welcome animate-fade-in-up" id="welcomeEng">
      <strong id="engNameBanner">Hello, Engineer</strong><br>
      <span>Accept available jobs and update your task status here.</span>
    </div>

    <h5 class="dash-section-title animate-fade-in-up">
      <span class="icon-wrap">ğŸ“‚</span> Available Jobs
    </h5>
    <p class="text-muted small mb-3 animate-fade-in-up">Accept a job to add it to your tasks.</p>
    <div class="card card-dash mb-4 animate-fade-in-up animate-delay-1">
      <div class="card-body">
        <div id="availableList">Loading...</div>
      </div>
    </div>

    <h5 class="dash-section-title animate-fade-in-up">
      <span class="icon-wrap">âœ…</span> My Tasks
    </h5>
    <div class="card card-dash animate-fade-in-up animate-delay-2">
      <div class="card-body">
        <div id="tasksList">Loading...</div>
      </div>
    </div>
  </div>

  <script>
    const emptyState = (icon, msg) => '<div class="empty-state"><div class="empty-icon">' + icon + '</div><p>' + msg + '</p></div>';
    async function loadMe() {
      const res = await fetch('/api/me', { credentials: 'include' });
      if (res.ok) {
        const d = await res.json();
        const name = d.name || 'Engineer';
        document.getElementById('engName').textContent = 'Hello, ' + name;
        document.getElementById('engNameBanner').textContent = 'Hello, ' + name;
      }
    }
    async function loadAvailable() {
      const res = await fetch('/api/engineer/available-jobs', { credentials: 'include' });
      if (res.status === 401) { window.location.href = '/engineer-login.html'; return; }
      const list = await res.json();
      const html = list.length === 0
        ? emptyState('ğŸ“­', 'No available jobs right now. New complaints will appear here.')
        : list.map(j => '<div class="job-card d-flex flex-wrap justify-content-between align-items-start gap-3"><div class="flex-grow-1"><div class="job-title">#' + j.id + ' â€“ ' + j.service_type + '</div><div class="job-meta">' + (j.description || '').slice(0, 80) + (j.description && j.description.length > 80 ? 'â€¦' : '') + '</div><div class="job-meta">Customer: ' + j.user_name + ' Â· ' + j.user_phone + '</div><div class="job-address">ğŸ“ ' + (j.user_address || 'Address not provided') + '</div></div><div><button class="btn btn-primary btn-accept" onclick="acceptJob(' + j.id + ')">Accept job</button></div></div>').join('');
      document.getElementById('availableList').innerHTML = html;
    }
    window.acceptJob = async function(cid) {
      const res = await fetch('/api/engineer/accept-job', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ complaint_id: cid }), credentials: 'include' });
      if (res.ok) { loadAvailable(); loadTasks(); } else { const d = await res.json().catch(() => ({})); alert(d.error || 'Failed'); }
    };
    async function loadTasks() {
      const res = await fetch('/api/engineer/tasks', { credentials: 'include' });
      if (res.status === 401) return;
      const list = await res.json();
      const statusClass = s => s === 'Completed' ? 'badge-completed' : s === 'In Progress' ? 'badge-progress' : 'badge-assigned';
      const html = list.length === 0
        ? emptyState('ğŸ“‹', 'No tasks yet. Accept a job from above.')
        : list.map(t => {
            let action = '';
            if (t.status === 'Assigned') action = '<select class="form-select form-select-sm w-auto d-inline-block" style="max-width:160px" onchange="updateStatus(' + t.id + ', this.value)"><option value="">Update status</option><option value="In Progress">In Progress</option><option value="Completed">Completed</option></select>';
            else if (t.status === 'In Progress') action = '<select class="form-select form-select-sm w-auto d-inline-block" style="max-width:160px" onchange="updateStatus(' + t.id + ', this.value)"><option value="">Update</option><option value="Completed">Mark Completed</option></select>';
            return '<div class="job-card"><div class="d-flex flex-wrap justify-content-between align-items-start gap-2"><div><div class="job-title">#' + t.id + ' â€“ ' + t.service_type + '</div><div class="job-meta">' + (t.description || '').slice(0, 60) + 'â€¦</div><div class="job-meta">Customer: ' + t.user_name + ' Â· ' + t.user_phone + '</div><div class="job-address">ğŸ“ ' + (t.user_address || 'â€“') + '</div></div><div class="d-flex align-items-center gap-2 flex-wrap"><span class="badge ' + statusClass(t.status) + '">' + t.status + '</span> ' + action + '</div></div></div>';
          }).join('');
      document.getElementById('tasksList').innerHTML = html;
    }
    window.updateStatus = async function(cid, status) {
      if (!status) return;
      await fetch('/api/engineer/update-status', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ complaint_id: cid, status }), credentials: 'include' });
      loadTasks();
    };
    document.getElementById('engLogout').onclick = async (e) => {
      e.preventDefault();
      await fetch('/api/logout', { method: 'POST', credentials: 'include' });
      window.location.href = '/';
    };
    loadMe();
    loadAvailable();
    loadTasks();
  </script>
</body>
</html>
